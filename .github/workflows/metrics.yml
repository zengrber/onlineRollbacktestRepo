# to use this, place this script in .github/workflows/

name: cloudrollback-metrics

on:
  push:
    branches:
      - master       
    # paths:
    #   - "**/*.md" # file type filter optional

jobs:
  send-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0    

      - name: Collect diff and stats
        id: diff
        shell: bash
        run: |
          set -euo pipefail

          # find base commit
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            BASE_REF=$(git rev-parse HEAD~1)
            echo "Base commit: $BASE_REF"
          else
            BASE_REF=
            echo "This is the first commit; diff against empty tree"
          fi

          # stats
          if [ -z "${BASE_REF}" ]; then
            git diff --name-only HEAD > files.txt
            # numstat compare HEAD with empty
            lines_changed=$(git diff --numstat HEAD | awk '{a+=$1; b+=$2} END{print a+b+0}')
            git diff HEAD > diff.patch
          else
            git diff --name-only "$BASE_REF" HEAD > files.txt
            lines_changed=$(git diff --numstat "$BASE_REF" HEAD | awk '{a+=$1; b+=$2} END{print a+b+0}')
            git diff "$BASE_REF" HEAD > diff.patch
          fi

          files_changed=$(wc -l < files.txt | tr -d ' ')
          echo "files_changed=$files_changed"
          echo "lines_changed=$lines_changed"

          # gzip + base64 diff
          gzip -c diff.patch | base64 | tr -d '\n' > diff.b64

          echo "files_changed=$files_changed" >> $GITHUB_OUTPUT
          echo "lines_changed=$lines_changed" >> $GITHUB_OUTPUT

      - name: Build commit graph JSON (last 50 commits)
        id: graph
        shell: bash
        run: |
          set -euo pipefail

          # fetch latest 50 commits: SHA, parents, author, date, subject
          git log --pretty=format:'%H%x09%P%x09%an%x09%ad%x09%s' > commits.tsv

          python << 'PY'
          import json

          items = []
          with open("commits.tsv", encoding="utf-8") as f:
              for line in f:
                  line = line.rstrip("\n")
                  if not line:
                      continue
                  parts = line.split("\t", 4)
                  if len(parts) != 5:
                      continue
                  sha, parents, author, date, subject = parts
                  items.append({
                      "sha": sha,
                      "parents": parents.split() if parents else [],
                      "author": author,
                      "date": date,
                      "subject": subject,
                  })

          with open("commit_graph.json", "w", encoding="utf-8") as out:
              json.dump(items, out)
          PY

          # gzip + base64 commit graph
          gzip -c commit_graph.json | base64 | tr -d '\n' > commit_graph.b64

      - name: Send event to CloudRollback API
        env:
           API_URL: https://ieeguhrobg.execute-api.us-east-1.amazonaws.com/prod
           API_KEY: jQKXkxrNGH8eJddiFX8AX5PngLVT82Mh2sg0KbqO
        shell: bash
        run: |
          set -euo pipefail

          # base64 diff
          diff_b64=$(cat diff.b64)
          graph_b64=$(cat commit_graph.b64)

          # JSON payload
          payload=$(jq -n \
            --arg repo      "${{ github.repository }}" \
            --arg branch    "${{ github.ref_name }}" \
            --arg commit    "${{ github.sha }}" \
            --arg event     "push" \
            --arg diff_b64  "$diff_b64" \
            --arg graph_b64 "$graph_b64" \
            --arg actor     "${{ github.actor }}" \
            --argjson files ${{ steps.diff.outputs.files_changed || 0 }} \
            --argjson lines ${{ steps.diff.outputs.lines_changed || 0 }} \
            '{
               repo:          $repo,
               branch:        $branch,
               commit_sha:    $commit,
               event_type:    $event,
               actor:         $actor,
               files_changed: $files,
               lines_changed: $lines,
               diff_b64:      $diff_b64,
               commit_graph_b64: $graph_b64
             }')

          echo "Payload (truncated diff / graph):"
          echo "$payload" | jq 'del(.diff_b64, .commit_graph_b64)'

          # API Gateway /events
          curl -sS -w "\nHTTP %{http_code}\n" -o resp.json -X POST "$API_URL/events" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $API_KEY" \
            -d "$payload"

          echo "Response from Lambda:"
          cat resp.json
